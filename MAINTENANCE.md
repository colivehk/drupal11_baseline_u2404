# Drupal Maintenance Quick Guide (generated by drupal_installV7.5.5_collab_perms)

This VM uses a **3-user model** to avoid permission fights:

- **root**: system packages + services (apt, nginx/php/mariadb configs, systemctl)
- **ubuntu**: human operator (SSH login, edit code, upload files, run composer/drush)
- **www-data**: web runtime (php-fpm/nginx). Only needs **write** access to `sites/default/files`.

## Golden rules

1) **Code ownership**
- Code (modules/themes/vendor) should be owned by **ubuntu:drupal**
- Directories should be `2775` (setgid) so new files inherit group `drupal`.

2) **Runtime writes**
- `/var/www/drupal/web/sites/default/files` must be owned by **www-data:drupal**
- Directories: `2775`, files: `664` (group writable)

3) **Composer keys (pubkeys)**
- Composer pubkeys live under the user running composer: `/home/ubuntu/.config/composer`
- In this model, composer is run as **ubuntu**, so pubkeys belong to **ubuntu**.

## Daily commands (run as ubuntu)

### Composer (install/upgrade modules)
```bash
cd /var/www/drupal
composer require drupal/XXX
composer update drupal/XXX
```

### Drush
```bash
cd /var/www/drupal
./vendor/bin/drush --uri=http://192.168.64.18 cr
./vendor/bin/drush --uri=http://192.168.64.18 updb -y
./vendor/bin/drush --uri=http://192.168.64.18 cim -y
./vendor/bin/drush --uri=http://192.168.64.18 cex -y
```

## Deploying a custom module (tar.gz) via SSH upload

Recommended workflow (no sudo):

1) Upload `my_module.tar.gz` to `/home/ubuntu`
2) Extract into modules/custom:
```bash
cd /var/www/drupal
tar -xzf /home/ubuntu/my_module.tar.gz -C web/modules/custom
```
3) Rebuild caches:
```bash
cd /var/www/drupal
./vendor/bin/drush --uri=http://192.168.64.18 cr
```

## When you see Permission denied (unlink css/js) on cache rebuild

That usually means `sites/default/files` ownership was polluted.

Fix it (root):
```bash
sudo chown -R www-data:drupal /var/www/drupal/web/sites/default/files
sudo find /var/www/drupal/web/sites/default/files -type d -exec chmod 2775 {} \;
sudo find /var/www/drupal/web/sites/default/files -type f -exec chmod 0664 {} \;
```

Or run this script in pure fix mode:
```bash
sudo -E bash "/home/ubuntu/drupal_installV7.5.5.sh" --fix-perms
```

## System services (root only)
```bash
sudo systemctl restart php8.3-fpm nginx mariadb
sudo nginx -t
```
